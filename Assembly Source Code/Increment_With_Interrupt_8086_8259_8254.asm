;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Fri Jan 8 2021
; Processor: 8086
; Compiler:  MASM32
;
; Before starting simulation set Internal Memory Size 
; in the 8086 model properties to 0x10000
;====================================================================
STACKSG	SEGMENT PARA STACK 'STACK'
	 DW 12 DUP(?)
STACKSG	ENDS

DATASG		SEGMENT PARA 'DATA'

OLDOF		DW 0
OLDSG		DW 0
DATASG	ENDS

CODE    SEGMENT PUBLIC 'CODE'
        ASSUME CS:CODE,	DS:DATASG, SS:STACKSG
	
NEWINT PROC FAR
      PUSH BP
      MOV BP, SP
      INC AX
      
      POP BP
      IRET
NEWINT	ENDP

START:
        ;8253 ADRESS IS 78H - 7AH - 7CH - 7EH
	;8259 ADRESS IS 60H - 62H - 64H - 66H
	;8254 CONTROL WORD 			SC1 SC2 RW1 RW2 M2 M1 M0 BCD
	
	MOV AL, 00010101B				; COUNTER 0, 8 BIT, MODE 2, BCD
	OUT 7EH, AL
	
	MOV AL, 0FH
	OUT 78H, AL					;  SENDING 15  TO COUNTER 0
	
	XOR AX,AX
	MOV ES,AX
	
	 
	MOV AL, 40H
	MOV AH, 4					;40H TYPE ADDRESS
	MUL AH
	MOV BX, AX					; AX = 40H x 4   ADDRESS OF INTRRUPT
	
	; SAVE OLD INTERUPT TABLE VALUE
	MOV AX, WORD PTR ES:[BX]
	MOV OLDOF, AX
	MOV AX, WORD PTR ES:[BX+2]
	MOV OLDSG, AX
	
	;CHANGE INTERRUPT TABLE VALUES
	LEA AX, NEWINT				;OFFSET OF THE PROC
	MOV WORD PTR ES:[BX], AX 		; ADD THE OFFSET VALUE TO VECTOR TABLE
	MOV AX, CS
	MOV WORD PTR ES:[BX+2], AX	; ADD THE NEW SEGMENT VALUE TO THE TABLE
	
	MOV AL, 13H					; 0001 0011	EDGE TRIGGER, SINGLE, SELECT IC4		
	OUT 60H, AL					; ADDRESS PIN IS 0, ONLY ICW1
	MOV AL, 40H					; 0100 0000	INTERRUPT TYPE, IR0
	OUT 62H, AL					; ADDRESS PIN IS 1, ICW2, ICW4
	
	MOV AL, 03H					; AEOI, PM	ICW4
	OUT 62H, AL
	STI
	XOR AX, AX
	
	
ENDLESS:

    JMP ENDLESS
	
	XOR AX, AX
	MOV ES, AX
	MOV AX, OLDOF
	MOV WORD PTR ES:[BX], AX
	MOV AX, OLDSG
	MOV WORD PTR ES:[BX+2], AX
	
CODE    ENDS
        END START